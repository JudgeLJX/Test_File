<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flip Book Demo</title>
  <style>
    :root {
      --w: min(92vw, 1440px);
      --h: min(86vh, 960px);
      --radius: 18px;
      --shadow: 0 18px 50px rgba(0,0,0,.28);
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
      background: #0b0b0f;
      color: #fff;
      display: grid;
      place-items: center;
      height: 100vh;
      overflow: hidden;
    }

    .app { width: var(--w); }

    .stage {
      position: relative;
      width: var(--w);
      height: var(--h);
      perspective: 1400px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: visible; /* 3D翻页时需要可见 */
    }

    .page {
      position: absolute;
      inset: 0;
      border-radius: var(--radius);
      overflow: hidden;
      transform-style: preserve-3d;
      backface-visibility: hidden;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      will-change: transform, opacity;
    }

    /* 流星/星空层 */
    .page .meteorFx{
      display: block;            /* 避免 canvas inline 导致尺寸异常 */
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      mix-blend-mode: screen;    /* 更像发光叠加，不想要就删掉 */
    }

    /* 内容层：放文字/图片 */
    .page .content-layer {
      position: absolute;
      inset: 0;
      padding: 26px;
      pointer-events: none;
      z-index: 2;  /* 内容压在流星上面 */
    }

    .item {
      position: absolute;
      pointer-events: none;
      user-select: none;
    }

    .item.text {
      max-width: 46%;
      line-height: 1.5;
      text-shadow: 0 3px 12px rgba(0,0,0,.55);
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 14px 16px;
    }

    .item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 14px;
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.14);
    }

    /* 翻页动画：当前页向左翻过去 */
    .flip-next {
      transform-origin: left center;
      animation: flipNext .72s ease-in-out forwards;
    }
    @keyframes flipNext {
      0%   { transform: rotateY(0deg); }
      100% { transform: rotateY(-180deg); }
    }

    /* 翻回动画：上一页从左侧翻回来 */
    .flip-prev {
      transform-origin: left center;
      animation: flipPrev .72s ease-in-out forwards;
    }
    @keyframes flipPrev {
      0%   { transform: rotateY(-180deg); }
      100% { transform: rotateY(0deg); }
    }

    .toolbar {
      margin-top: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .btns { display: flex; gap: 10px; }

    button {
      appearance: none;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: #fff;
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      transition: transform .08s ease, background .15s ease;
    }
    button:hover { background: rgba(255,255,255,.12); }
    button:active { transform: translateY(1px); }
    button:disabled { opacity: .45; cursor: not-allowed; }

    .hint {
      opacity: .8;
      font-size: 13px;
      white-space: nowrap;
    }

    /* ===== 开场信封动画（替代原 lock 卡片）===== */
    .lock.intro{
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: radial-gradient(ellipse at center, rgba(0,0,0,.62), rgba(0,0,0,.92));
      z-index: 9999;
    }

    .envelope{
      width: min(380px, 80vw);
      height: calc(min(380px, 80vw) * 0.66);
      position: relative;
      cursor: pointer;
      transform: translateY(0);
      animation: envFloat 2.2s ease-in-out infinite;
      outline: none;
    }
    @keyframes envFloat{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-8px); }
    }

    .envelope *{ box-sizing: border-box; }

    .env-back{
      position: absolute;
      inset: 0;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 24px 70px rgba(0,0,0,.45);
    }

    .env-letter{
      position: absolute;
      left: 7%;
      right: 7%;
      bottom: 10%;
      height: 78%;
      border-radius: 14px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      transform: translateY(0);
      transition: transform .75s cubic-bezier(.2,.9,.2,1), opacity .3s ease;
      z-index: 1;
      overflow: hidden;
    }

    .letter-content{
      padding: 18px 16px;
      text-align: center;
    }
    .letter-title{
      font-size: 18px;
      font-weight: 650;
      margin-bottom: 8px;
    }
    .letter-sub{
      font-size: 13px;
      opacity: .85;
    }

    .env-front{
      position: absolute;
      inset: 0;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      clip-path: polygon(0 40%, 50% 70%, 100% 40%, 100% 100%, 0 100%);
      z-index: 2;
    }

    .env-flap{
      position: absolute;
      inset: 0;
      border-radius: 18px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      clip-path: polygon(0 40%, 50% 0, 100% 40%, 50% 70%);
      transform-origin: 50% 40%;
      transform: rotateX(0deg);
      transition: transform .65s cubic-bezier(.2,.9,.2,1);
      z-index: 3;
    }

    .lock.intro.opening .envelope{
      animation: none;
    }
    .lock.intro.opening .env-flap{
      transform: rotateX(170deg);
    }
    .lock.intro.opening .env-letter{
      transform: translateY(-28%);
    }

    .lock.intro.dismiss{
      opacity: 0;
      pointer-events: none;
      transition: opacity .45s ease;
    }
  </style>
</head>

<body>
  <!-- 开场信封 -->
  <div class="lock intro" id="lock" aria-label="开场信封">
    <div class="envelope" id="envelope" role="button" tabindex="0" aria-label="点击打开信封">
      <div class="env-back"></div>
      <div class="env-letter">
        <div class="letter-content">
          <div class="letter-title">送给你的一封信</div>
          <div class="letter-sub">点击信封打开</div>
        </div>
      </div>
      <div class="env-front"></div>
      <div class="env-flap"></div>
    </div>
  </div>

  <div class="app">
    <div class="stage" id="stage"></div>

    <div class="toolbar">
      <div class="btns">
        <button id="prevBtn">上一页</button>
        <button id="nextBtn">下一页</button>
        <button id="toggleMusicBtn">暂停音乐</button>
      </div>
      <div class="hint" id="hint">
        ←/→ 翻页｜空格 播放/暂停｜第 <span id="pageNo">1</span>/<span id="pageTotal">1</span> 页
      </div>
    </div>
  </div>

  <audio id="bgm" preload="auto"></audio>

  <script>
    // ====== 你主要改这里：每页的背景图、音乐、内容元素 ======
    const pages = [
      {
        bg: "assets/bg1.jpg",
        music: "assets/music1.mp3",
        items: [
          { type: "text", x: "6%", y: "8%", w: "44%", h: "auto", text: "第一页标题/文字内容：\n这里可以写一段介绍。", fontSize: 18 },
          { type: "img", x: "58%", y: "14%", w: "34%", h: "40%", src: "assets/photo1.png" },
          { type: "img", x: "58%", y: "58%", w: "28%", h: "26%", src: "assets/photo2.png" },
        ],
      },
      {
        bg: "assets/bg2.jpg",
        music: "assets/music2.mp3",
        items: [
          { type: "text", x: "8%", y: "10%", w: "52%", h: "auto", text: "第二页：\n每页都可以有不同的布局。", fontSize: 18 },
          { type: "img", x: "18%", y: "48%", w: "38%", h: "40%", src: "assets/photo1.png" },
        ],
      },
    ];

    // ====== 基础运行逻辑 ======
    const stage = document.getElementById("stage");
    const bgm = document.getElementById("bgm");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const toggleMusicBtn = document.getElementById("toggleMusicBtn");
    const pageNoEl = document.getElementById("pageNo");
    const pageTotalEl = document.getElementById("pageTotal");
    const lock = document.getElementById("lock");
    const envelope = document.getElementById("envelope");

    pageTotalEl.textContent = String(pages.length);

    let current = 0;
    let isAnimating = false;
    let userUnlockedAudio = false;

    // 预渲染：为每一页创建一个div（叠在一起，后面页在底下）
    // ✅ 关键：先 append 到 DOM，再 initMeteorFx，避免 canvas 尺寸=0
    const pageEls = pages.map((p, i) => {
      const el = document.createElement("div");
      el.className = "page";
      el.style.backgroundImage = `url("${p.bg}")`;
      el.style.zIndex = String(pages.length - i);

      // ① 每页插入一个 canvas（流星层）
      const fx = document.createElement("canvas");
      fx.className = "meteorFx";
      el.appendChild(fx);

      // ② 内容层（图片/文字）
      const layer = document.createElement("div");
      layer.className = "content-layer";

      (p.items || []).forEach(item => {
        const it = document.createElement("div");
        it.className = `item ${item.type}`;
        it.style.left = item.x;
        it.style.top = item.y;
        it.style.width = item.w;
        it.style.height = item.h;

        if (item.type === "text") {
          it.style.fontSize = (item.fontSize || 16) + "px";
          it.textContent = item.text || "";
        } else if (item.type === "img") {
          const img = document.createElement("img");
          img.src = item.src;
          img.alt = item.alt || "";
          it.appendChild(img);
        }
        layer.appendChild(it);
      });

      el.appendChild(layer);
      stage.appendChild(el); // ✅ 先挂 DOM
      initMeteorFx(fx);      // ✅ 再启动动画
      return el;
    });

    function initMeteorFx(canvas){
      const reduceMotion = window.matchMedia &&
        window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      if (reduceMotion) return;

      const ctx = canvas.getContext("2d", { alpha: true });
      let W = 0, H = 0;
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

      const cfg = {
        spawnPerSecond: 6,
        speedMin: 900,
        speedMax: 1600,
        lenMin: 120,
        lenMax: 320,
        widthMin: 1.2,
        widthMax: 2.6,
        angle: Math.PI / 4, // ✅ 右下（+45°）
        alphaMin: 0.25,
        alphaMax: 0.85,
        maxMeteors: 80,
        stars: 90
      };

      function rand(a,b){ return a + Math.random()*(b-a); }

      let stars = [];
      function makeStars(){
        stars = Array.from({length: cfg.stars}, () => ({
          x: Math.random()*W,
          y: Math.random()*H,
          r: Math.random()*1.6 + 0.2,
          a: Math.random()*0.6 + 0.15,
          tw: Math.random()*1.5 + 0.5,
          ph: Math.random()*Math.PI*2
        }));
      }

      function resize(){
        const w = Math.floor(canvas.clientWidth);
        const h = Math.floor(canvas.clientHeight);
        if (!w || !h) return; // 防止 0 尺寸锁死
        W = w; H = h;
        canvas.width = Math.floor(W * dpr);
        canvas.height = Math.floor(H * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        makeStars();
      }

      // 用 ResizeObserver 保证拿到真实尺寸
      const ro = new ResizeObserver(() => resize());
      ro.observe(canvas);

      const meteors = [];
      function spawnMeteor(){
        if (meteors.length >= cfg.maxMeteors) return;

        const angle = cfg.angle + rand(-0.08, 0.08);
        const dx = Math.cos(angle), dy = Math.sin(angle);

        const fromTop = Math.random() < 0.55;
        const x = fromTop ? rand(0, W) : -rand(0, W*0.2);
        const y = fromTop ? -rand(0, H*0.3) : rand(0, H);

        meteors.push({
          x, y, dx, dy,
          speed: rand(cfg.speedMin, cfg.speedMax),
          len: rand(cfg.lenMin, cfg.lenMax),
          w: rand(cfg.widthMin, cfg.widthMax),
          a: rand(cfg.alphaMin, cfg.alphaMax)
        });
      }

      function drawStarfield(t){
        for(const s of stars){
          const tw = (Math.sin(t*0.001*s.tw + s.ph)+1)*0.5;
          const a = s.a*(0.6+0.4*tw);
          ctx.beginPath();
          ctx.fillStyle = `rgba(255,255,255,${a})`;
          ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
          ctx.fill();
        }
      }

      function drawMeteor(m){
        const x2 = m.x - m.dx*m.len;
        const y2 = m.y - m.dy*m.len;
        const g = ctx.createLinearGradient(m.x, m.y, x2, y2);
        g.addColorStop(0, `rgba(255,255,255,${m.a})`);
        g.addColorStop(1, `rgba(255,255,255,0)`);
        ctx.strokeStyle = g;
        ctx.lineWidth = m.w;
        ctx.lineCap = "round";
        ctx.beginPath();
        ctx.moveTo(m.x, m.y);
        ctx.lineTo(x2, y2);
        ctx.stroke();
      }

      let last = performance.now();
      let spawnAcc = 0;

      function tick(now){
        if (!W || !H) {
          requestAnimationFrame(tick);
          return;
        }

        const dt = Math.min(0.033, (now - last)/1000);
        last = now;

        ctx.clearRect(0,0,W,H);
        drawStarfield(now);

        spawnAcc += dt * cfg.spawnPerSecond;
        while(spawnAcc >= 1){
          spawnMeteor();
          spawnAcc -= 1;
        }

        for(let i = meteors.length-1; i>=0; i--){
          const m = meteors[i];
          m.x += m.dx*m.speed*dt;
          m.y += m.dy*m.speed*dt;
          drawMeteor(m);

          if (m.x - m.dx*m.len > W + 120 || m.y - m.dy*m.len > H + 120) {
            meteors.splice(i,1);
          }
        }

        requestAnimationFrame(tick);
      }

      requestAnimationFrame(() => {
        resize();
        requestAnimationFrame(tick);
      });
    }

    function updateUI() {
      pageNoEl.textContent = String(current + 1);
      prevBtn.disabled = current <= 0 || isAnimating;
      nextBtn.disabled = current >= pages.length - 1 || isAnimating;
    }

    function playMusicFor(index) {
      if (!userUnlockedAudio) return;
      const src = pages[index]?.music;
      if (!src) return;

      // 切歌：停止上一首
      bgm.pause();
      bgm.currentTime = 0;
      bgm.src = src;

      bgm.play().then(() => {
        toggleMusicBtn.textContent = "暂停音乐";
      }).catch(() => {
        toggleMusicBtn.textContent = "播放音乐";
      });
    }

    updateUI();

    function goNext() {
      if (isAnimating || current >= pages.length - 1) return;
      isAnimating = true;
      updateUI();

      const leaving = pageEls[current];
      leaving.classList.remove("flip-prev");
      leaving.classList.add("flip-next");

      leaving.addEventListener("animationend", function handler() {
        leaving.removeEventListener("animationend", handler);
        current += 1;
        isAnimating = false;
        updateUI();
        playMusicFor(current);
      }, { once: true });
    }

    function goPrev() {
      if (isAnimating || current <= 0) return;
      isAnimating = true;
      updateUI();

      const comingBack = pageEls[current - 1];
      comingBack.classList.remove("flip-next");
      comingBack.classList.add("flip-prev");

      comingBack.addEventListener("animationend", function handler() {
        comingBack.removeEventListener("animationend", handler);
        current -= 1;
        isAnimating = false;
        updateUI();
        playMusicFor(current);
      }, { once: true });
    }

    prevBtn.addEventListener("click", goPrev);
    nextBtn.addEventListener("click", goNext);

    toggleMusicBtn.addEventListener("click", async () => {
      userUnlockedAudio = true;
      if (!bgm.src) playMusicFor(current);

      if (bgm.paused) {
        try {
          await bgm.play();
          toggleMusicBtn.textContent = "暂停音乐";
        } catch {
          toggleMusicBtn.textContent = "播放音乐";
        }
      } else {
        bgm.pause();
        toggleMusicBtn.textContent = "播放音乐";
      }
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowRight") goNext();
      if (e.key === "ArrowLeft") goPrev();
      if (e.key === " " ) { e.preventDefault(); toggleMusicBtn.click(); }
    });

    // ====== 开场信封：点击打开 -> 进入应用并解锁音乐 ======
    function enterAppFromIntro(){
      userUnlockedAudio = true;
      lock.classList.add("dismiss");
      setTimeout(() => {
        lock.style.display = "none";
        playMusicFor(current);
      }, 480);
    }

    function openEnvelope(){
      if (!lock || lock.classList.contains("opening")) return;
      lock.classList.add("opening");
      setTimeout(() => {
        enterAppFromIntro();
      }, 850);
    }

    envelope.addEventListener("click", openEnvelope);
    envelope.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        openEnvelope();
      }
    });
  </script>
</body>
</html>
